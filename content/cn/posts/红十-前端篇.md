---
title: "红十（前端篇）"
date: 2023-03-23
categories: ['Application']
draft: false
---

## 引言

这是红十游戏(http://8.130.97.117/)的前端篇，也是第二篇。这篇文章我会主要讲解游戏前端所用的技术栈和框架整合。

## 技术栈

项目最开始是只基于`Vue.js`写的，但在写游戏界面时又忽然想用用Web游戏框架，所以就增加了`Phaser.js`。两者的区别是在一些物理场景上`Phaser.js`有相应引擎，所以效果会更好，除此之外就是在写法上`Phaser.js`是编程式创建对象，`VUe.js`就是声明式了。因为棋牌游戏并不涉及物理场景，所以如果单纯用`Vue.js`我相信也可以完美胜任这一工作。

最终我使用`Phaser.js` + `Vue.js`，一方面取`Phaser.js`在图片加载、处理（切分图片为一个数组）上的便捷性，同时结合`Vue.js`在数据监听上的优势。闲言碎语不讲，直接来说代码。

## 框架整合

### @ion-phaser

如何在Vue项目中使用Phaser?有人给出了解决方案——`@ion-phaser`。

`@ion-phaser`是一个使用`Stencil.js`构建的Web组件，它可以让你在任何框架中（如Angular，React，Vue等）集成Phaser游戏框架。

首先，在Vue中通过`npm`安装`@ion-phaser`

```shell
npm install @ion-phaser/core --save
```

然后在main.js下配置一些参数：
```js
import { defineCustomElements as defineIonPhaser } from '@ion-phaser/core/loader';

Vue.config.ignoredElements = [/^ion-/]; // 避免Vue抛出未知元素的警告
defineIonPhaser(window); // 加载ion-phaser组件到window对象中
```

最后，在要使用Phaser的界面中，在\<html\>下加入
```html
<ion-phaser 
            v-bind:game.prop="game"
            v-bind:initialize.prop="initialize"
        />
```

在\<script\>下加入引用，并在Vue的data中加入两个变量：game，initialize，当initialize为true时Phaser就会启动：
```js
import Phaser from 'phaser'

export default {
    name: 'View',
    data() {
        return {
            game: {
                width: "100%",
                height: "100%",
                type: Phaser.AUTO,
                scene: {
                    preload: function() {   //预加载，一般加载图片等资源
                    },
                    create: function() {
                    },
                    update: function() {
                    }
            },
            initialize: false
        }
    }
}
```

这样就整合完成了，可是如果想顺畅地使用，还要考虑接下来的问题。

## 数据传递

要知道让两个框架愉快的合作是有些问题要处理的，最重要的就是数据怎么传递。

想象中，我们可以利用Vue向后端发起请求，与后端完成数据的收发与存储。同时使用Phaser利用这些数据进行渲染。

可问题是，Phaser和Vue一点也不沾边，怎么让他们共通数据？

后来我在`@ion-phaser`github下的issue中找到了答案：在\<script\>下声明一个变量vue，同时在Vue的`mounted`函数中为这个变量赋值
```js
mounted() {
    vue = this
}
```

这样就可以通过变量访问Vue下的资源了，由此实现了Phaser对Vue的数据读取和函数调用，也就是说Phaser能够根据数据渲染界面并调用Vue中的函数向后端发送数据了。

可是这只能初始化渲染界面，在Vue数据变化时如何告诉Phaser来重新渲染界面呢？我们可以利用Vue的`watch`功能。比如要监听Vue中变量`userInfo`的变化，可以在`game`变量的`create()`函数中使用一下代码：
```js
game: {
    vue.$watch('userInfo', (val)=> {
        console.log('watched userInfo changed to ', val)
    })
}
```

这样就完整地解决了数据传递的问题：用户在Phaser中的操作会使Phaser通过`vue`变量调用对应函数来传递到服务端；反过来，服务端的数据发送给Vue，`vue.$watch`会监听这一变化，并告知Phaser重新渲染界面。

## 后记

该项目的前端仍在优化中，之后会考虑基于`WebRTC`的实时通信。

> 参考链接：
> 
> @ion-phaser https://github.com/proyecto26/ion-phaser
> 